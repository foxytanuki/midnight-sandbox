version: "3.8"

services:
  node:
    image: "midnightnetwork/midnight-node:0.12.0"
    container_name: "midnight-node"
    ports:
      - "9944:9944" # WebSocket RPC
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9944/health"]
      interval: 2s
      timeout: 5s
      retries: 5
      start_period: 40s
    environment:
      CFG_PRESET: "dev"
    restart: unless-stopped

  indexer:
    container_name: "midnight-indexer"
    image: "midnightntwrk/indexer-standalone:2.1.1"
    ports:
      - "8088:8088" # GraphQL APIポート
    environment:
      RUST_LOG: "indexer=info,chain_indexer=info,indexer_api=info,wallet_indexer=info,indexer_common=info"
      # 32バイトのランダムな16進数エンコードされたシークレット（開発用）
      # 注意: 本番環境では適切なシークレットを生成してください
      APP__INFRA__SECRET: "303132333435363738393031323334353637383930313233343536373839303132"
      # ローカルノードのWebSocket URL
      APP__INFRA__NODE__URL: "ws://node:9944"
    depends_on:
      node:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8088/ready"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
