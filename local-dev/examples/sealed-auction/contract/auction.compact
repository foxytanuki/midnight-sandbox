// auction.compact
// 真の封印オークションコントラクト（コミットメントスキームを使用）

pragma language_version >= 0.18.0;
import CompactStandardLibrary;

// オンチェーン状態
export ledger bidCommitments: Set<Bytes<32>>;  // 入札コミットメントのセット
export ledger highestBid: Uint<64>;            // 最高入札額（公開後）
export ledger bidCount: Uint<64>;              // 入札数
export ledger isOpen: Boolean;                  // 入札受付中
export ledger isRevealed: Boolean;              // 公開済み

// コントラクト初期化
constructor() {
  highestBid = 0 as Uint<64>;
  bidCount = 0 as Uint<64>;
  isOpen = true;
  isRevealed = false;
}

// 入札（コミットメントを送信）
export circuit bid(commitment: Bytes<32>): [] {
  assert(isOpen, "auction is closed");
  assert(!bidCommitments.member(disclose(commitment)), "duplicate commitment");
  
  // コミットメントを保存（公開されるが、中身は秘密）
  bidCommitments.insert(disclose(commitment));
  bidCount = (bidCount + 1) as Uint<64>;
}

// 入札を締め切る
export circuit close_bidding(): [] {
  isOpen = false;
}

// 入札を公開
export circuit reveal(amount: Uint<64>, secret: Bytes<32>): [] {
  assert(!isOpen, "bidding is still open");
  
  // コミットメントを再計算して検証
  const commitment = persistentCommit<Uint<64>>(amount, secret);
  assert(bidCommitments.member(disclose(commitment)), "invalid commitment");
  
  // 最高額を更新（disclose()で公開）
  if (disclose(amount) > highestBid) {
    highestBid = disclose(amount);
  }
  
  isRevealed = true;
}

// 最高入札額を取得
export circuit get_highest_bid(): Uint<64> {
  assert(isRevealed, "not revealed yet");
  return highestBid;
}

// 入札数を取得
export circuit get_bid_count(): Uint<64> {
  return bidCount;
}

// オークションが公開されたか確認
export circuit is_revealed(): Boolean {
  return isRevealed;
}
