.PHONY: up down restart logs status health clean node-logs indexer-logs proof-logs faucet-logs shell

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆ
.DEFAULT_GOAL := help

# ç’°å¢ƒå¤‰æ•°
COMPOSE_FILE := compose.yaml

##@ åŸºæœ¬æ“ä½œ

up: ## ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã‚’èµ·å‹•
	docker compose -f $(COMPOSE_FILE) up -d
	@echo "ğŸš€ Midnight local environment starting..."
	@echo ""
	@echo "Endpoints:"
	@echo "  Node RPC:     ws://localhost:9944"
	@echo "  Indexer:      http://localhost:8088/graphql"
	@echo "  Proof Server: http://localhost:6300"
	@echo "  Faucet API:   http://localhost:3000"
	@echo ""
	@echo "Run 'make status' to check service health"

down: ## ç’°å¢ƒã‚’åœæ­¢
	docker compose -f $(COMPOSE_FILE) down
	@echo "âœ… Midnight local environment stopped"

restart: down up ## ç’°å¢ƒã‚’å†èµ·å‹•

##@ çŠ¶æ…‹ç¢ºèª

status: ## å„ã‚µãƒ¼ãƒ“ã‚¹ã®çŠ¶æ…‹ã‚’è¡¨ç¤º
	@echo "=== Service Status ==="
	@docker compose -f $(COMPOSE_FILE) ps

health: ## ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
	@echo "=== Health Check ==="
	@./scripts/check-health.sh

logs: ## å…¨ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒ­ã‚°ã‚’è¡¨ç¤º
	@exec docker compose -f $(COMPOSE_FILE) logs -f

node-logs: ## Node ã®ãƒ­ã‚°ã‚’è¡¨ç¤º
	@exec docker compose -f $(COMPOSE_FILE) logs -f node

indexer-logs: ## Indexer ã®ãƒ­ã‚°ã‚’è¡¨ç¤º
	@exec docker compose -f $(COMPOSE_FILE) logs -f indexer

proof-logs: ## Proof Server ã®ãƒ­ã‚°ã‚’è¡¨ç¤º
	@exec docker compose -f $(COMPOSE_FILE) logs -f proof-server

faucet-logs: ## Faucet API ã®ãƒ­ã‚°ã‚’è¡¨ç¤º
	@exec docker compose -f $(COMPOSE_FILE) logs -f faucet-api

##@ é–‹ç™ºãƒ„ãƒ¼ãƒ«

shell: ## Node ã‚³ãƒ³ãƒ†ãƒŠã«ã‚·ã‚§ãƒ«æ¥ç¶š
	@exec docker compose -f $(COMPOSE_FILE) exec node /bin/sh

wait: ## Node ãŒèµ·å‹•ã™ã‚‹ã¾ã§å¾…æ©Ÿ
	@exec ./scripts/wait-for-node.sh

fund: ## ã‚¢ãƒ‰ãƒ¬ã‚¹ã«è³‡é‡‘ã‚’ä¾›çµ¦ (ADDRESS=mnemonic|shielded-address|unshielded-address ã‚’æŒ‡å®š)
	@if [ -z "$(ADDRESS)" ]; then \
		echo "Usage: make fund ADDRESS=\"<mnemonic or address>\""; \
		echo ""; \
		echo "Examples:"; \
		echo "  make fund ADDRESS=\"your twelve word mnemonic phrase here\""; \
		echo "  make fund ADDRESS=mn_shield-addr_undeployed1q..."; \
		echo "  make fund ADDRESS=mn_addr_undeployed1q..."; \
		exit 1; \
	fi
	@./scripts/fund.sh "$(ADDRESS)"

##@ Compact

compile: ## Compact ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‚’ã‚³ãƒ³ãƒ‘ã‚¤ãƒ« (CONTRACT=path ã‚’æŒ‡å®š)
	@if [ -z "$(CONTRACT)" ]; then \
		echo "Usage: make compile CONTRACT=path/to/contract.compact"; \
		exit 1; \
	fi
	compact compile $(CONTRACT) $(dir $(CONTRACT))out

##@ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—

clean: down ## ç’°å¢ƒã‚’å®Œå…¨ã«ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ— (ãƒ‡ãƒ¼ã‚¿å«ã‚€)
	docker compose -f $(COMPOSE_FILE) down -v --remove-orphans
	@echo "ğŸ§¹ Cleaned up all containers and volumes"

##@ ãƒ˜ãƒ«ãƒ—

help: ## ã“ã®ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º
	@awk 'BEGIN {FS = ":.*##"; printf "\nUsage:\n  make \033[36m<target>\033[0m\n"} /^[a-zA-Z_-]+:.*?##/ { printf "  \033[36m%-15s\033[0m %s\n", $$1, $$2 } /^##@/ { printf "\n\033[1m%s\033[0m\n", substr($$0, 5) } ' $(MAKEFILE_LIST)

